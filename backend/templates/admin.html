{% extends 'base.html' %}

{% block title %}Админка недвижимости{% endblock %}

{% block bulk_actions %}

{% endblock %}

{% block head %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        .property-card {
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
        }
        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .price {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        .area {
            color: #6c757d;
        }
        .filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            text-align: center;
        }
        .stats-card h5 {
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .stats-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        .loading {
            display: none;
        }
        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .modal-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
        .list-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            padding: 15px;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .list-image {
            width: 180px;
            height: 135px;
            object-fit: cover;
            border-radius: 6px;
        }
        .list-photo-column {
            flex: 0 0 180px;
            margin-right: 20px;
        }
        .list-phone-column {
            flex: 0 0 200px;
            margin-right: 30px;
        }
        .list-action-column {
            flex: none;
            text-align: center;
        }
        .list-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .list-address {
            color: #6c757d;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .list-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
        }
        .list-details {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .list-badge {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #495057;
        }
        .list-description {
            color: #6c757d;
            font-size: 0.85em;
            line-height: 1.4;
        }
        .contact-info {
            text-align: left;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .contact-phone {
            font-size: 1.1em;
            font-weight: 500;
        }
        .contact-phone a {
            color: #0d6efd;
        }
        .contact-phone a:hover {
            color: #0a58ca;
            text-decoration: none;
        }
        .contact-full {
            font-size: 0.8em;
        }
        .dadata-address {
            font-size: 0.9em;
        }
        .dadata-main {
            margin-bottom: 4px;
        }
        .list-info-column {
            flex: 1;
            margin-right: 20px;
        }
        @media (max-width: 768px) {
            .list-item {
                flex-direction: column;
                padding: 10px;
            }
            .list-photo-column {
                flex: none;
                margin-right: 0;
                margin-bottom: 15px;
                text-align: center;
            }
            .list-image {
                width: 100%;
                max-width: 250px;
                height: 180px;
                border-radius: 8px;
            }
            .list-info-column {
                margin-right: 0;
                margin-bottom: 15px;
            }
            .list-phone-column {
                flex: none;
                margin-right: 0;
                margin-bottom: 15px;
            }
            .list-action-column {
                flex: none;
                text-align: center;
            }
            .list-details {
                gap: 8px;
            }
            .list-badge {
                font-size: 0.75em;
                padding: 3px 6px;
            }
        }
    </style>
{% endblock %}

{% block content %}
        <!-- Оборачиваю всё, что относится к объектам, в <div id="properties-section"> ... </div> -->
        <div id="properties-section">

            <!-- Фильтры -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="filters">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-filter me-2"></i>Фильтры</h5>
                            <div class="d-flex align-items-center gap-3">
                                <div class="btn-group me-2" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="cardView" value="cards" checked>
                                    <label class="btn btn-outline-primary" for="cardView">
                                        <i class="fas fa-th-large me-1"></i>Карточки
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="listView" value="list">
                                    <label class="btn btn-outline-primary" for="listView">
                                        <i class="fas fa-list me-1"></i>Список
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Поиск</label>
                                <input type="text" class="form-control" id="global-search" placeholder="ID, адрес, ЖК, телефон..." autocomplete="off">
                                <div id="autocomplete-list" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Цена от</label>
                                <input type="number" class="form-control" id="price-min" placeholder="Мин. цена">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Цена до</label>
                                <input type="number" class="form-control" id="price-max" placeholder="Макс. цена">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Площадь от</label>
                                <input type="number" class="form-control" id="area-min" placeholder="Мин. площадь">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Площадь до</label>
                                <input type="number" class="form-control" id="area-max" placeholder="Макс. площадь">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Комнаты</label>
                                <select class="form-select" id="rooms-filter">
                                    <option value="">Все</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4+</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Рейтинг Дома от</label>
                                <input type="number" class="form-control" id="rating-min" placeholder="Мин. рейтинг Дома">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Рейтинг Дома до</label>
                                <input type="number" class="form-control" id="rating-max" placeholder="Макс. рейтинг Дома">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Рейтинг ЖК от</label>
                                <input type="number" class="form-control" id="yandex-rating-min" placeholder="Мин. рейтинг ЖК">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Рейтинг ЖК до</label>
                                <input type="number" class="form-control" id="yandex-rating-max" placeholder="Макс. рейтинг ЖК">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 d-flex align-items-center gap-3">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search me-1"></i>
                                    Применить фильтры
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>
                                    Очистить
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportCSV()">
                                    <i class="fas fa-download me-1"></i>
                                    Экспорт CSV
                                </button>
                                <button class="btn btn-info ms-2" onclick="showRecentChanges()">
                                    <i class="fas fa-history me-1"></i>
                                    История цен
                                </button>
                                <button class="btn btn-warning ms-2" onclick="showPriceStatistics()">
                                    <i class="fas fa-chart-line me-1"></i>
                                    Статистика
                                </button>
                                <div class="form-check ms-4">
                                    <input class="form-check-input" type="checkbox" value="1" id="contacts-only-filter">
                                    <label class="form-check-label" for="contacts-only-filter">
                                        Только с контактами
                                    </label>
                                </div>
                                <div class="form-check ms-4">
                                    <input class="form-check-input" type="checkbox" value="1" id="in-complex-only-filter">
                                    <label class="form-check-label" for="in-complex-only-filter">
                                        Только в ЖК
                                    </label>
                                </div>
                                <div class="form-check ms-4">
                                    <input class="form-check-input" type="checkbox" value="1" id="in-sale-only-filter">
                                    <label class="form-check-label" for="in-sale-only-filter">
                                        В продаже
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Загрузка -->
            <div class="row" id="loading">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных...</p>
                </div>
            </div>

            <!-- Список объектов -->
            <div class="row" id="properties-container">
                <!-- Здесь будут карточки объектов -->
            </div>

            <!-- Пагинация -->
            <div class="row">
                <div class="col-12">
                    <div class="pagination-container">
                        <nav>
                            <ul class="pagination" id="pagination">
                                <!-- Пагинация будет добавлена динамически -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Новый раздел связанных объектов и ЖК -->
        <div id="linked-section" style="display:none;">
            <div class="container mt-4">
                <h2 class="mb-4"><i class="fas fa-link me-2"></i>Связанные объекты и ЖК</h2>
                
                <!-- Статистика связей -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-map-marker-alt me-2"></i>Адресов со связями</h5>
                            <h3 id="total-linked-addresses">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-building me-2"></i>Всего объектов</h5>
                            <h3 id="total-linked-properties">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-city me-2"></i>Всего ЖК</h5>
                            <h3 id="total-linked-complexes">0</h3>
                        </div>
                    </div>
                </div>
                
                <!-- Список связанных данных -->
                <div id="linked-data-container">
                    <!-- Здесь будут отображаться связанные данные -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для деталей -->
    <div class="modal fade" id="propertyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Детали объекта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Содержимое будет добавлено динамически -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для карты адреса -->
    <div class="modal fade" id="addressMapModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addressMapModalTitle">Адрес на карте</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="address-map-container" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для toast-уведомлений -->
    <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        <div id="toast-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let currentViewMode = 'cards';
        let complexesMap = null; // Глобальная переменная для карты ЖК
        let complexMarkers = []; // Массив маркеров ЖК на карте
        let markerClusterGroup = null; // Группа кластеризации маркеров
        let addressMap = null;
        let autocompleteTimeout = null;

        // Форматирование цены
        function formatPrice(price) {
            if (!price) return 'Цена не указана';
            return new Intl.NumberFormat('ru-RU').format(price) + ' ₽';
        }

        // Форматирование площади
        function formatArea(area) {
            if (!area) return 'Площадь не указана';
            return area + ' м²';
        }

        // Получение текущего режима отображения
        function getCurrentViewMode() {
            const cardView = document.getElementById('cardView');
            const listView = document.getElementById('listView');
            
            if (cardView.checked) return 'cards';
            if (listView.checked) return 'list';
            return 'cards';
        }

        // Обработчик изменения режима отображения
        function handleViewModeChange() {
            currentViewMode = getCurrentViewMode();
            loadProperties(currentPage);
        }

        // Загрузка статистики
        function loadStats() {
            // Показываем спиннеры
            document.getElementById('total-properties').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('phone-count').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('sent-to-cc').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('watermarks-removed').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('with-address').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('in-complex').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('generated-description-count').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            document.getElementById('in-sale-count').innerHTML = '<span class="spinner-border spinner-border-sm text-light" role="status"></span>';
            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => {
                    document.getElementById('total-properties').textContent = stats.total_properties;
                    document.getElementById('phone-count').textContent = stats.phone_count;
                    document.getElementById('sent-to-cc').textContent = stats.sent_to_callcenter;
                    document.getElementById('watermarks-removed').textContent = stats.watermarks_removed;
                    document.getElementById('with-address').textContent = stats.with_address;
                    document.getElementById('in-complex').textContent = stats.in_complex;
                    document.getElementById('generated-description-count').textContent = stats.generated_description_count;
                    document.getElementById('in-sale-count').textContent = stats.in_sale_count;
                })
                .catch(() => {
                    showToast('Ошибка загрузки статистики', 'danger');
                });
        }

        // Загрузка данных
        async function loadProperties(page = 1) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('properties-container');
            
            loading.style.display = 'block';
            container.innerHTML = '';

            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 12,
                    ...currentFilters
                });

                const response = await fetch(`/api/properties-fast?${params}`);
                const data = await response.json();

                currentPage = data.current_page;
                totalPages = data.pages;

                displayProperties(data.properties);
                displayPagination();
            } catch (error) {
                showToast('Ошибка загрузки данных', 'danger');
                container.innerHTML = '<div class="col-12 text-center text-danger"><p>Ошибка загрузки данных</p></div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Отображение объектов
        function displayProperties(properties) {
            const container = document.getElementById('properties-container');
            
            if (properties.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><p>Объекты не найдены</p></div>';
                return;
            }

            if (currentViewMode === 'cards') {
                displayPropertiesAsCards(properties, container);
            } else {
                displayPropertiesAsList(properties, container);
            }
        }

        // Отображение объектов в виде карточек
        function displayPropertiesAsCards(properties, container) {
            container.innerHTML = properties.map(property => `
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="card property-card h-100">
                        <div class="card-img-top">
                            ${getFirstImage(property.images, property.antiznak_photos)}
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${property.title}</h6>
                            <p class="card-text text-muted small mb-1">ID: ${property.id}</p>
                            <p class="card-text text-muted small">${property.dadata_address && property.dadata_address.address ? property.dadata_address.address : ''}</p>
                            <div class="price">${formatPrice(property.price)}</div>
                            <div class="area">${formatArea(property.total_area)}</div>
                            <div class="mt-2">
                                <span class="badge bg-primary">${property.rooms_count || 0} комн.</span>
                                ${property.floor ? `<span class="badge bg-secondary">${property.floor}/${property.total_floors || '?'} эт.</span>` : ''}
                                ${property.construction_year ? `<span class="badge bg-info">${property.construction_year}</span>` : ''}
                                ${property.in_sale ? `<span class="badge bg-success"><i class="fas fa-tag me-1"></i>В продаже</span>` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-outline-primary w-100" onclick="showPropertyDetails(${property.id})">
                                <i class="fas fa-eye me-1"></i>Подробнее
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Отображение объектов в виде списка
        function displayPropertiesAsList(properties, container) {
            container.innerHTML = properties.map(property => {
                console.log('property:', property); // ОТЛАДКА
                return `
                <div class="col-12" id="property-row-${property.id}">
                    <div class="list-item d-flex align-items-center">
                        <!-- Колонка 1: Фото -->
                        <div class="list-photo-column">
                            ${getFirstImageForList(property.images, property.antiznak_photos)}
                        </div>
                        
                        <!-- Колонка 2: Информация об объекте -->
                        <div class="list-info-column">
                            <div class="list-title">${property.title}</div>
                            <div class="text-muted small mb-1">ID: ${property.id}</div>
                            <div class="list-address">${property.dadata_address && property.dadata_address.address ? property.dadata_address.address : ''}</div>
                            ${property.yandex_complex_name ? `<div class="text-primary small mb-1"><i class='fab fa-yandex me-1'></i>${property.yandex_complex_name}</div>` : ''}
                            <div class="list-price">${formatPrice(property.price)}</div>
                            <div class="list-details">
                                <span class="list-badge">
                                    <i class="fas fa-ruler-combined me-1"></i>${formatArea(property.total_area)}
                                </span>
                                <span class="list-badge">
                                    <i class="fas fa-door-open me-1"></i>${property.rooms_count || 0} комн.
                                </span>
                                ${property.floor ? `<span class="list-badge">
                                    <i class="fas fa-building me-1"></i>${property.floor}/${property.total_floors || '?'} эт.
                                </span>` : ''}
                                ${property.construction_year ? `<span class="list-badge">
                                    <i class="fas fa-calendar me-1"></i>${property.construction_year}
                                </span>` : ''}
                                ${property.price_per_sqm ? `<span class="list-badge">
                                    <i class="fas fa-calculator me-1"></i>${formatPrice(property.price_per_sqm)}/м²
                                </span>` : ''}
                                ${property.rating && property.dadata_address && property.dadata_address.address ? `<span class="list-badge bg-warning"><i class="fas fa-star me-1"></i>Рейтинг Дома: ${property.rating}</span>` : ''}
                                ${property.yandex_rating && property.yandex_complex_name ? `<span class="list-badge bg-info"><i class="fab fa-yandex me-1"></i>Рейтинг ЖК: ${property.yandex_rating}</span>` : ''}
                                ${property.in_sale ? `<span class="list-badge bg-success"><i class="fas fa-tag me-1"></i>В продаже</span>` : ''}
                            </div>
                            ${property.description ? `<div class="list-description">${property.description.substring(0, 150)}${property.description.length > 150 ? '...' : ''}</div>` : ''}
                            ${property.generated_description ? `<div class="list-description text-success"><i class="fas fa-magic me-1"></i>${property.generated_description.substring(0, 150)}${property.generated_description.length > 150 ? '...' : ''}</div>` : ''}
                        </div>
                        
                        <!-- Колонка 3: Телефон -->
                        <div class="list-phone-column">
                            ${(() => {
                                // Извлекаем номер телефона
                                let phone = null;
                                if (property.contacts) {
                                    const match = property.contacts.match(/(\+?\d{10,15})/);
                                    if (match) phone = match[1];
                                }
                                if (phone) {
                                    if (property.sent_to_callcenter) {
                                        return '<span class="badge bg-success">Отправлено в КЦ</span>';
                                    } else {
                                        return `<button class=\"btn btn-sm btn-outline-warning\" onclick=\"sendPhoneToCC('${phone}', ${property.id}, this)\"><i class=\"fas fa-phone-volume me-1\"></i>Отправить в КЦ</button>`;
                                    }
                                } else {
                                    return formatContacts(property.contacts);
                                }
                            })()}
                        </div>
                        
                        <!-- Колонка 4: Действия -->
                        <div class="list-action-column">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm" onclick="showPropertyDetails(${property.id})">
                                    <i class="fas fa-eye me-1"></i>Подробнее
                                </button>
                                ${getRemoveWatermarksButton(property)}
                                ${property.content ? `<button class="btn btn-outline-success btn-sm" onclick="generateDescription(${property.id}, this)">
                                    <i class="fas fa-magic me-1"></i>Генерировать описание
                                </button>` : ''}
                                ${property.latitude && property.longitude ? `
                                    <button class="btn btn-outline-info btn-sm" onclick="geocodeProperty(${property.id}, this)">
                                        <i class="fas fa-map-marker-alt me-1"></i>Геокодировать
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        }

        // Получение первого изображения для списка
        function getFirstImageForList(images, antiznak_photos) {
            if (!images) {
                return '<div class="list-image bg-light d-flex align-items-center justify-content-center"><i class="fas fa-image text-muted" style="font-size: 2em;"></i></div>';
            }
            
            const imageUrls = images.split(', ');
            const firstImage = imageUrls[0];
            
            return `<img src="${firstImage}" class="list-image" alt="Фото объекта" onerror="this.parentElement.innerHTML='<div class=\\'list-image bg-light d-flex align-items-center justify-content-center\\'><i class=\\'fas fa-image text-muted\\' style=\\'font-size: 2em;\\'></i></div>'">`;
        }

        // Получение первого изображения
        function getFirstImage(images, antiznak_photos) {
            if (!images) {
                return '<div class="property-image bg-light d-flex align-items-center justify-content-center"><i class="fas fa-image text-muted" style="font-size: 3em;"></i></div>';
            }
            
            const imageUrls = images.split(', ');
            const firstImage = imageUrls[0];
            
            return `<img src="${firstImage}" class="property-image" alt="Фото объекта" onerror="this.parentElement.innerHTML='<div class=\\'property-image bg-light d-flex align-items-center justify-content-center\\'><i class=\\'fas fa-image text-muted\\' style=\\'font-size: 3em;\\'></i></div>'">`;
        }

        // Отображение пагинации
        function displayPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Кнопка "Предыдущая"
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadProperties(${currentPage - 1})">Предыдущая</a>
                </li>
            `;

            // Номера страниц
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadProperties(${i})">${i}</a>
                    </li>
                `;
            }

            // Кнопка "Следующая"
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadProperties(${currentPage + 1})">Следующая</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Применение фильтров
        function applyFilters() {
            const q = document.getElementById('global-search').value.trim();
            const contactsOnly = document.getElementById('contacts-only-filter').checked;
            const inComplexOnly = document.getElementById('in-complex-only-filter').checked;
            const inSaleOnly = document.getElementById('in-sale-only-filter').checked;
            const ratingMin = document.getElementById('rating-min').value;
            const ratingMax = document.getElementById('rating-max').value;
            const yandexRatingMin = document.getElementById('yandex-rating-min').value;
            const yandexRatingMax = document.getElementById('yandex-rating-max').value;
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;
            const areaMin = document.getElementById('area-min').value;
            const areaMax = document.getElementById('area-max').value;
            const rooms = document.getElementById('rooms-filter').value;
            
            currentFilters = q ? { q } : {};
            if (contactsOnly) currentFilters.contacts_only = 1;
            if (inComplexOnly) currentFilters.in_complex_only = 1;
            if (inSaleOnly) currentFilters.in_sale_only = 1;
            if (ratingMin) currentFilters.rating_min = ratingMin;
            if (ratingMax) currentFilters.rating_max = ratingMax;
            if (yandexRatingMin) currentFilters.yandex_rating_min = yandexRatingMin;
            if (yandexRatingMax) currentFilters.yandex_rating_max = yandexRatingMax;
            if (priceMin) currentFilters.price_min = priceMin;
            if (priceMax) currentFilters.price_max = priceMax;
            if (areaMin) currentFilters.area_min = areaMin;
            if (areaMax) currentFilters.area_max = areaMax;
            if (rooms) currentFilters.rooms = rooms;
            // Добавить yandex_building_id если был выбран ЖК
            if (window.lastSelectedYandexBuildingId) {
                currentFilters.yandex_building_id = window.lastSelectedYandexBuildingId;
            }
            loadProperties(1);
        }

        // Очистка фильтров
        function clearFilters() {
            document.getElementById('global-search').value = '';
            document.getElementById('contacts-only-filter').checked = false;
            document.getElementById('in-complex-only-filter').checked = false;
            document.getElementById('in-sale-only-filter').checked = false;
            document.getElementById('rating-min').value = '';
            document.getElementById('rating-max').value = '';
            document.getElementById('yandex-rating-min').value = '';
            document.getElementById('yandex-rating-max').value = '';
            document.getElementById('price-min').value = '';
            document.getElementById('price-max').value = '';
            document.getElementById('area-min').value = '';
            document.getElementById('area-max').value = '';
            document.getElementById('rooms-filter').value = '';
            currentFilters = {};
            loadProperties(1);
        }

        // Загрузка данных из CSV
        async function loadData() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Загрузка...';
            button.disabled = true;

            try {
                const response = await fetch('/api/load-data');
                const result = await response.json();
                
                if (result.success) {
                    showToast('Данные успешно загружены!', 'success');
                    loadProperties(1);
                } else {
                    showToast('Ошибка загрузки данных', 'danger');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showToast('Ошибка загрузки данных', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }



        // Показать детали объекта
        async function showPropertyDetails(propertyId) {
            try {
                const response = await fetch(`/api/properties?id=${propertyId}`);
                const data = await response.json();
                
                if (data.properties.length > 0) {
                    const property = data.properties[0];
                    displayPropertyModal(property);
                } else {
                    showToast('Объект не найден', 'warning');
                }
            } catch (error) {
                console.error('Ошибка загрузки деталей:', error);
                showToast('Ошибка загрузки деталей объекта', 'danger');
            }
        }

        // Отображение модального окна с деталями
        function displayPropertyModal(property) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = property.title;
            
            // ОТЛАДКА: выводим условия для кнопок
            let phone = null;
            if (property.contacts) {
                const match = property.contacts.match(/(\+?\d{10,15})/);
                if (match) phone = match[1];
            }
            console.log('phone:', phone, 'sent_to_callcenter:', property.sent_to_callcenter, 'source_url:', property.source_url, 'antiznak_photos:', property.antiznak_photos, 'antiznak_status_status:', property.antiznak_status_status);
            
            const images = (property.antiznak_photos && property.antiznak_photos.length > 0)
                ? property.antiznak_photos
                : (property.images ? property.images.split(', ') : []);

            // Новый блок: подробное описание
            const contentHTML = property.content ? `
                <div class="mb-3">
                    <h6>Подробное описание:</h6>
                    <div>${property.content}</div>
                </div>
            ` : '';

            // Блок сгенерированного описания
            const generatedDescriptionHTML = property.generated_description ? `
                <div class="mb-3">
                    <h6><i class="fas fa-magic me-2"></i>Сгенерированное описание:</h6>
                    <div class="border-start border-success ps-3">${property.generated_description}</div>
                </div>
            ` : '';

            const imagesHTML = images.length > 0 ? `
                <div class="mb-3">
                    <h6>Фотографии:</h6>
                    <div class="row">
                        ${images.slice(0, 6).map(img => `
                            <div class="col-md-4 mb-2">
                                <img src="${img}" class="img-fluid modal-image" alt="Фото объекта">
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            // Аналогичные квартиры (same_flats)
            let sameFlatsHTML = '';
            if (property.same_flats && property.same_flats.length > 0) {
                sameFlatsHTML = `
                    <div class="mb-3">
                        <h6>Квартиры в этом доме с таким же количеством комнат:</h6>
                        <div class="row">
                            ${property.same_flats.map(flat => {
                                const flatImg = (flat.antiznak_photos && flat.antiznak_photos.length > 0)
                                    ? flat.antiznak_photos[0]
                                    : (flat.images ? flat.images.split(', ')[0] : '');
                                return `
                                    <div class="col-md-6 mb-2">
                                        <div class="card h-100">
                                            <div class="card-img-top" style="height:160px;overflow:hidden;text-align:center;">
                                                ${flatImg ? `<img src="${flatImg}" style="max-height:160px;max-width:100%;object-fit:cover;" alt="Фото">` : '<div class="bg-light d-flex align-items-center justify-content-center" style="height:100%;"><i class="fas fa-image text-muted" style="font-size:2em;"></i></div>'}
                                            </div>
                                            <div class="card-body p-2">
                                                <div class="fw-bold mb-1">${flat.address || ''}</div>
                                                <div class="small text-muted mb-1">Площадь: ${flat.total_area || '?'} м², Этаж: ${flat.floor || '?'}${flat.total_floors ? '/' + flat.total_floors : ''}</div>
                                                <div class="mb-1">Цена: <span class="fw-bold">${formatPrice(flat.price)}</span></div>
                                                ${flat.rating ? `<span class="badge bg-warning"><i class="fas fa-star me-1"></i>Рейтинг Дома: ${flat.rating}</span>` : ''}
                                            </div>
                                            <div class="card-footer p-2 text-center">
                                                <button class="btn btn-sm btn-outline-primary" onclick="showPropertyDetails(${flat.id})"><i class="fas fa-eye me-1"></i>Подробнее</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основная информация:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Адрес:</strong> ${property.address}</li>
                            <li><strong>Цена:</strong> ${formatPrice(property.price)}</li>
                            <li><strong>Площадь:</strong> ${formatArea(property.total_area)}</li>
                            <li><strong>Комнаты:</strong> ${property.rooms_count || 'Не указано'}</li>
                            <li><strong>Этаж:</strong> ${property.floor ? `${property.floor}/${property.total_floors || '?'}` : 'Не указано'}</li>
                            <li><strong>Год постройки:</strong> ${property.construction_year || 'Не указано'}</li>
                            <li><strong>Цена за м²:</strong> ${formatPrice(property.price_per_sqm)}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Описание:</h6>
                        <p>${property.description || 'Описание отсутствует'}</p>
                        ${property.contacts ? `<h6>Контакты:</h6><p>${property.contacts}</p>` : ''}
                    </div>
                </div>
                ${contentHTML}
                ${generatedDescriptionHTML}
                ${imagesHTML}
                ${sameFlatsHTML}
            `;

            const modal = new bootstrap.Modal(document.getElementById('propertyModal'));
            modal.show();
        }

        // Форматирование контактов
        function formatContacts(contacts) {
            if (!contacts) {
                return '<div class="text-muted">Контакты не указаны</div>';
            }
            
            // Извлекаем телефон из строки контактов
            const phoneMatch = contacts.match(/Телефон:\s*(\d+)/);
            if (phoneMatch) {
                const phone = phoneMatch[1];
                return `
                    <div class="contact-info">
                        <div class="contact-phone">
                            <i class="fas fa-phone me-2"></i>
                            <a href="tel:${phone}" class="text-decoration-none">${phone}</a>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="contact-info">
                    <div class="contact-full">${contacts}</div>
                </div>
            `;
        }

        // Форматирование адреса DaData
        function formatDadataAddress(dadataAddress) {
            if (!dadataAddress) {
                return '<div class="text-muted">Адрес не определен</div>';
            }
            
            return `
                <div class="dadata-address">
                    <div class="dadata-main">
                        <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                        <strong>${dadataAddress.address}</strong>
                    </div>
                </div>
            `;
        }

        // Геокодирование объекта
        async function geocodeProperty(propertyId, btn) {
            const button = btn || event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            try {
                const response = await fetch(`/api/geocode-property/${propertyId}`);
                const result = await response.json();
                if (result.success) {
                    showToast('Адрес успешно определен!', 'success');
                    // Подгружаем только один объект и обновляем его строку
                    const propResp = await fetch(`/api/properties?id=${propertyId}`);
                    const propData = await propResp.json();
                    if (propData.properties && propData.properties.length > 0) {
                        const property = propData.properties[0];
                        // Собираем HTML для одной строки
                        const html = `
                            <div class=\"list-item d-flex align-items-center\">
                                <div class=\"list-photo-column\">${getFirstImageForList(property.images, property.antiznak_photos)}</div>
                                <div class=\"list-info-column\">
                                    <div class=\"list-title\">${property.title}</div>
                                    <div class=\"list-address\">${property.dadata_address && property.dadata_address.address ? property.dadata_address.address : ''}</div>
                                    ${property.yandex_complex_name ? `<div class="text-primary small mb-1"><i class='fab fa-yandex me-1'></i>${property.yandex_complex_name}</div>` : ''}
                                    <div class=\"list-price\">${formatPrice(property.price)}</div>
                                    <div class=\"list-details\">
                                        <span class=\"list-badge\"><i class=\"fas fa-ruler-combined me-1\"></i>${formatArea(property.total_area)}</span>
                                        <span class=\"list-badge\"><i class=\"fas fa-door-open me-1\"></i>${property.rooms_count || 0} комн.</span>
                                        ${property.floor ? `<span class=\"list-badge\"><i class=\"fas fa-building me-1\"></i>${property.floor}/${property.total_floors || '?'} эт.</span>` : ''}
                                        ${property.construction_year ? `<span class=\"list-badge\"><i class=\"fas fa-calendar me-1\"></i>${property.construction_year}</span>` : ''}
                                        ${property.price_per_sqm ? `<span class=\"list-badge\"><i class=\"fas fa-calculator me-1\"></i>${formatPrice(property.price_per_sqm)}/м²</span>` : ''}
                                        ${property.rating && property.dadata_address && property.dadata_address.address ? `<span class="list-badge bg-warning"><i class="fas fa-star me-1"></i>Рейтинг Дома: ${property.rating}</span>` : ''}
                                        ${property.yandex_rating && property.yandex_complex_name ? `<span class="list-badge bg-info"><i class="fab fa-yandex me-1"></i>Рейтинг ЖК: ${property.yandex_rating}</span>` : ''}
                                    </div>
                                    ${property.description ? `<div class=\"list-description\">${property.description.substring(0, 150)}${property.description.length > 150 ? '...' : ''}</div>` : ''}
                                    ${property.generated_description ? `<div class="list-description text-success"><i class="fas fa-magic me-1"></i>${property.generated_description.substring(0, 150)}${property.generated_description.length > 150 ? '...' : ''}</div>` : ''}
                                </div>
                                <div class=\"list-phone-column\">${formatContacts(property.contacts)}</div>
                                <div class=\"list-action-column\">
                                    <div class=\"d-grid gap-2\">
                                        <button class=\"btn btn-primary btn-sm\" onclick=\"showPropertyDetails(${property.id})\"><i class=\"fas fa-eye me-1\"></i>Подробнее</button>
                                        ${property.source_url && property.source_url.startsWith('http') && 
                                            (
                                                (!property.antiznak_photos || property.antiznak_photos.length === 0) || 
                                                (property.antiznak_status_status && property.antiznak_status_status !== 'done')
                                            ) ? `
                                            <button class=\"btn btn-warning btn-sm\" onclick=\"removeWatermarks(${property.id}, this)\"><i class=\"fas fa-eraser me-1\"></i>Удалить водяные знаки</button>` : ''}
                                        ${property.content ? `<button class="btn btn-outline-success btn-sm" onclick="generateDescription(${property.id}, this)"><i class="fas fa-magic me-1"></i>Генерировать описание</button>` : ''}
                                        ${property.latitude && property.longitude ? `<button class=\"btn btn-outline-info btn-sm\" onclick=\"geocodeProperty(${property.id}, this)\"><i class=\"fas fa-map-marker-alt me-1\"></i>Определить адрес</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        const row = document.getElementById(`property-row-${property.id}`);
                        if (row) row.innerHTML = html;
                    }
                } else {
                    showToast(`Ошибка: ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('Ошибка геокодирования:', error);
                showToast('Ошибка при определении адреса', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Геокодирование всех объектов
        async function geocodeAllProperties(event) {
            console.log('geocodeAllProperties called');
            alert('Функция geocodeAllProperties вызвана!');
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;

            try {
                const response = await fetch('/api/geocode-all');
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Обработано: ${result.processed} объектов, ошибок: ${result.errors}, всего: ${result.total}`, 'success');
                    // Перезагружаем данные для обновления отображения
                    loadProperties(currentPage);
                } else {
                    showToast(`Ошибка: ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('Ошибка массового геокодирования:', error);
                showToast('Ошибка при массовом определении адресов', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Удаление водяных знаков
        async function removeWatermarks(propertyId, btn) {
            const button = btn;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            try {
                const response = await fetch(`/api/antiznak/${propertyId}`, {method: 'POST'});
                const result = await response.json();
                if (result.success && result.status === 'done') {
                    showToast('Водяные знаки удалены!', 'success');
                    loadProperties(currentPage);
                } else if (result.status === 'error') {
                    showToast('Ошибка: ' + result.error, 'danger');
                } else {
                    showToast('Статус: ' + result.status, 'info');
                }
            } catch (e) {
                showToast('Ошибка при удалении водяных знаков', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            var cardView = document.getElementById('cardView');
            if (cardView) cardView.addEventListener('change', handleViewModeChange);
            var listView = document.getElementById('listView');
            if (listView) listView.addEventListener('change', handleViewModeChange);
            var complexListView = document.getElementById('complexListView');
            if (complexListView) complexListView.addEventListener('change', handleComplexViewModeChange);
            var complexMapView = document.getElementById('complexMapView');
            if (complexMapView) complexMapView.addEventListener('change', handleComplexViewModeChange);
            var menuObjects = document.getElementById('menu-objects');
            if (menuObjects) menuObjects.addEventListener('click', showPropertiesSection);
            var menuComplexes = document.getElementById('menu-complexes');
            if (menuComplexes) menuComplexes.addEventListener('click', showComplexesSection);
            if (window.location.pathname === '/complexes') {
                if (typeof showComplexesSection === 'function') showComplexesSection();
            } else {
                if (typeof showPropertiesSection === 'function') showPropertiesSection();
                // ГАРАНТИРОВАННО загружаем объекты при первом открытии
                if (typeof loadProperties === 'function') loadProperties(1);
            }
            if (typeof loadStats === 'function') loadStats();
            if (typeof loadYandexComplexesList === 'function') loadYandexComplexesList();
        });

        // Обработчик переключения вида ЖК
        function handleComplexViewModeChange() {
            const isListView = document.getElementById('complexListView').checked;
            const complexesSection = document.getElementById('complexes-section');
            
            if (isListView) {
                complexesSection.classList.remove('complex-map-view');
                complexesSection.classList.add('complex-list-view');
                if (complexesMap) {
                    complexesMap.invalidateSize();
                }
            } else {
                complexesSection.classList.remove('complex-list-view');
                complexesSection.classList.add('complex-map-view');
                initComplexesMap();
                loadComplexesForMap();
            }
        }

        // Инициализация карты ЖК
        function initComplexesMap() {
            if (complexesMap) {
                return; // Карта уже инициализирована
            }
            
            complexesMap = L.map('complexes-map').setView([55.7558, 37.6176], 10); // Москва по умолчанию
            
            // Добавляем слой OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(complexesMap);
            
            // Создаем группу кластеризации маркеров
            markerClusterGroup = L.markerClusterGroup({
                chunkedLoading: true, // Загрузка маркеров по частям для лучшей производительности
                maxClusterRadius: 50, // Максимальный радиус кластера
                spiderfyOnMaxZoom: true, // Раскрытие кластера при максимальном зуме
                showCoverageOnHover: true, // Показывать область кластера при наведении
                zoomToBoundsOnClick: true, // Приближение к границам кластера при клике
                disableClusteringAtZoom: 16, // Отключить кластеризацию на высоком зуме
                iconCreateFunction: function(cluster) {
                    // Кастомная иконка кластера с количеством маркеров
                    const count = cluster.getChildCount();
                    let className = 'marker-cluster-';
                    let size = 'medium';
                    
                    if (count < 10) {
                        className += 'small';
                        size = 'small';
                    } else if (count < 100) {
                        className += 'medium';
                        size = 'medium';
                    } else {
                        className += 'large';
                        size = 'large';
                    }
                    
                    return L.divIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster ' + className,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            complexesMap.addLayer(markerClusterGroup);
        }

        // Загрузка ЖК для отображения на карте
        async function loadComplexesForMap() {
            try {
                const response = await fetch('/api/complexes?per_page=1000'); // Загружаем больше ЖК для карты
                const data = await response.json();
                displayComplexesOnMap(data.complexes);
            } catch (error) {
                console.error('Ошибка загрузки ЖК для карты:', error);
            }
        }

        // Отображение ЖК на карте с кластеризацией
        function displayComplexesOnMap(complexes) {
            // Очищаем существующие маркеры
            markerClusterGroup.clearLayers();
            complexMarkers = [];
            
            const complexesWithCoords = complexes.filter(c => c.latitude && c.longitude);
            
            if (complexesWithCoords.length === 0) {
                alert('Нет ЖК с координатами для отображения на карте');
                return;
            }
            
            console.log(`Загружаем ${complexesWithCoords.length} ЖК на карту с кластеризацией`);
            
            // Создаем маркеры для каждого ЖК и добавляем в группу кластеризации
            complexesWithCoords.forEach(complex => {
                const marker = L.marker([complex.latitude, complex.longitude])
                    .bindPopup(createComplexPopupContent(complex));
                
                complexMarkers.push(marker);
                markerClusterGroup.addLayer(marker);
            });
            
            // Автоматическое центрирование и масштабирование карты
            if (complexesWithCoords.length > 1) {
                // Создаем границы всех маркеров
                const bounds = L.latLngBounds(complexesWithCoords.map(c => [c.latitude, c.longitude]));
                
                // Вычисляем центр с наибольшей плотностью маркеров
                const center = findOptimalCenter(complexesWithCoords);
                
                // Устанавливаем центр карты на оптимальную точку
                complexesMap.setView(center, 11); // Зум 11 - хороший уровень для просмотра города
                
                // Через небольшую задержку подстраиваем границы для лучшего отображения
                setTimeout(() => {
                    complexesMap.fitBounds(bounds, { 
                        padding: [30, 30], // Отступы от краев
                        maxZoom: 12 // Максимальный зум при автоматическом масштабировании
                    });
                }, 100);
                
            } else if (complexesWithCoords.length === 1) {
                // Если только один ЖК, устанавливаем зум поближе
                complexesMap.setView([complexesWithCoords[0].latitude, complexesWithCoords[0].longitude], 14);
            }
        }

        // Функция для поиска оптимального центра с наибольшей плотностью маркеров
        function findOptimalCenter(complexes) {
            if (complexes.length === 0) {
                return [55.7558, 37.6176]; // Москва по умолчанию
            }
            
            if (complexes.length === 1) {
                return [complexes[0].latitude, complexes[0].longitude];
            }
            
            // Вычисляем средний центр всех координат
            const avgLat = complexes.reduce((sum, c) => sum + c.latitude, 0) / complexes.length;
            const avgLng = complexes.reduce((sum, c) => sum + c.longitude, 0) / complexes.length;
            
            // Находим маркер, ближайший к среднему центру
            let closestComplex = complexes[0];
            let minDistance = Infinity;
            
            complexes.forEach(complex => {
                const distance = Math.sqrt(
                    Math.pow(complex.latitude - avgLat, 2) + 
                    Math.pow(complex.longitude - avgLng, 2)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestComplex = complex;
                }
            });
            
            return [closestComplex.latitude, closestComplex.longitude];
        }

        // Создание содержимого попапа для маркера ЖК
        function createComplexPopupContent(complex) {
            return `
                <div class="complex-marker-popup">
                    <h6>${complex.name || 'Без названия'}</h6>
                    <p><i class="fas fa-map-marker-alt me-1"></i>${complex.address || 'Адрес не указан'}</p>
                    <p><strong>Застройщик:</strong> ${complex.developer_name || 'Не указан'}</p>
                    <p><strong>Сдача:</strong> ${complex.ready_date || 'Не указана'}</p>
                    <p><strong>Этажей:</strong> ${complex.min_floor || ''}${complex.max_floor ? ' - ' + complex.max_floor : ''}</p>
                    <span class="badge bg-info">${complex.status || ''}</span>
                    ${complex.dadata_address && complex.dadata_address.address ? 
                        `<p class="text-success mt-2"><i class="fas fa-map-marker-alt me-1"></i>${complex.dadata_address.address}</p>` : ''}
                    ${complex.latitude && complex.longitude && (!complex.dadata_address || !complex.dadata_address.address) ? 
                        `<button class="btn btn-outline-info btn-sm w-100" onclick="geocodeComplexFromMap(${complex.id}, this)">
                            <i class="fas fa-map-marker-alt me-1"></i>Геокодировать
                        </button>` : ''}
                </div>
            `;
        }

        // Геокодирование ЖК из карты
        async function geocodeComplexFromMap(complexId, btn) {
            const button = btn;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/api/geocode-complex/${complexId}`);
                const result = await response.json();
                
                if (result.success) {
                    showToast('Адрес успешно определен!', 'success');
                    // Обновляем карту
                    loadComplexesForMap();
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('Ошибка при определении адреса ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Новые функции для ЖК
        function showComplexesSection() {
            document.getElementById('complexes-section').style.display = '';
            document.getElementById('properties-section').style.display = 'none';
            loadComplexes(1);
        }
        function applyComplexFilters() {
            loadComplexes(1);
        }
        async function loadComplexes(page = 1) {
            const name = document.getElementById('complex-name-filter').value;
            const developer = document.getElementById('complex-developer-filter').value;
            const status = document.getElementById('complex-status-filter').value;
            const params = new URLSearchParams({ page, per_page: 12, name, developer, status });
            const response = await fetch(`/api/complexes?${params}`);
            const data = await response.json();
            displayComplexes(data.complexes);
            displayComplexesPagination(data);
        }
        function displayComplexes(complexes) {
            const container = document.getElementById('complexes-list');
            if (!complexes.length) {
                container.innerHTML = '<div class="col-12 text-center"><p>ЖК не найдены</p></div>';
                return;
            }
            container.innerHTML = complexes.map(c => `
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="card h-100">
                        <img src="${c.photo_url || ''}" class="card-img-top" alt="Фото ЖК" onerror="this.src='https://via.placeholder.com/300x200?text=Нет+фото'">
                        <div class="card-body">
                            <h5 class="card-title">${c.name || 'Без названия'}</h5>
                            <p class="card-text text-muted small mb-1"><i class="fas fa-map-marker-alt me-1"></i>${c.address || ''}</p>
                            <p class="mb-1"><strong>Застройщик:</strong> ${c.developer_name || ''}</p>
                            <p class="mb-1"><strong>Сдача:</strong> ${c.ready_date || ''}</p>
                            <p class="mb-1"><strong>Этажей:</strong> ${c.min_floor || ''}${c.max_floor ? ' - ' + c.max_floor : ''}</p>
                            <span class="badge bg-info">${c.status || ''}</span>
                            <p class="mb-1 text-success">${c.dadata_address && c.dadata_address.address ? `<i class='fas fa-map-marker-alt me-1'></i>${c.dadata_address.address}` : ''}</p>
                            ${c.latitude && c.longitude && (!c.dadata_address || !c.dadata_address.address) ? `<button class="btn btn-outline-info btn-sm w-100 mt-2" onclick="geocodeComplex(${c.id}, this)"><i class='fas fa-map-marker-alt me-1'></i>Геокодировать</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function displayComplexesPagination(data) {
            const pagination = document.getElementById('complexes-pagination');
            if (data.pages <= 1) { pagination.innerHTML = ''; return; }
            let html = '';
            html += `<li class="page-item ${data.current_page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadComplexes(${data.current_page - 1})">Предыдущая</a></li>`;
            for (let i = Math.max(1, data.current_page - 2); i <= Math.min(data.pages, data.current_page + 2); i++) {
                html += `<li class="page-item ${i === data.current_page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadComplexes(${i})">${i}</a></li>`;
            }
            html += `<li class="page-item ${data.current_page === data.pages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="loadComplexes(${data.current_page + 1})">Следующая</a></li>`;
            pagination.innerHTML = html;
        }

        // Новые функции для импорта ЖК
        async function importComplexes() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Импорт...';
            button.disabled = true;
            try {
                const response = await fetch('/api/import-complexes');
                const result = await response.json();
                if (result.success) {
                    showToast('Импорт ЖК завершен!', 'success');
                    loadComplexes(1);
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('Ошибка при импорте ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function showPropertiesSection() {
            var propSection = document.getElementById('properties-section');
            if (propSection) propSection.style.display = 'block';
            var complexesSection = document.getElementById('complexes-section');
            if (complexesSection) complexesSection.style.display = 'none';
            // ГАРАНТИРОВАННО загружаем объекты при переключении
            if (typeof loadProperties === 'function') loadProperties(1);
        }

        // Новые функции для географии
        async function geocodeAllComplexes() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            try {
                const response = await fetch('/api/geocode-all-complexes');
                const result = await response.json();
                if (result.success) {
                    showToast(`Обработано: ${result.processed} ЖК, ошибок: ${result.errors}, всего: ${result.total}`, 'success');
                    loadComplexes(1);
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('Ошибка при массовом геокодировании ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function geocodeComplex(complexId, btn) {
            const button = btn;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            try {
                const response = await fetch(`/api/geocode-complex/${complexId}`);
                const result = await response.json();
                if (result.success) {
                    showToast('Адрес успешно определен!', 'success');
                    loadComplexes(1);
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('Ошибка при определении адреса ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Функция для связывания объектов и ЖК
        async function linkPropertiesComplexes(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/link-properties-complexes');
                const result = await response.json();
                
                if (result.success) {
                    showLinkedSection();
                    displayLinkedData(result.linked_data);
                    updateLinkedStats(result.linked_data);
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (error) {
                console.error('Ошибка связывания:', error);
                showToast('Ошибка при связывании объектов и ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Показать раздел связанных данных
        function showLinkedSection() {
            const propertiesSection = document.getElementById('properties-section');
            const complexesSection = document.getElementById('complexes-section');
            const linkedSection = document.getElementById('linked-section');
            
            if (propertiesSection) {
                propertiesSection.style.display = 'none';
            }
            if (complexesSection) {
                complexesSection.style.display = 'none';
            }
            if (linkedSection) {
                linkedSection.style.display = '';
            }
        }

        // Обновить статистику связей
        function updateLinkedStats(linkedData) {
            let totalProperties = 0;
            let totalComplexes = 0;
            
            linkedData.forEach(item => {
                totalProperties += item.properties.length;
                totalComplexes += item.complexes.length;
            });
            
            const totalAddressesEl = document.getElementById('total-linked-addresses');
            const totalPropertiesEl = document.getElementById('total-linked-properties');
            const totalComplexesEl = document.getElementById('total-linked-complexes');
            
            if (totalAddressesEl) {
                totalAddressesEl.textContent = linkedData.length;
            }
            if (totalPropertiesEl) {
                totalPropertiesEl.textContent = totalProperties;
            }
            if (totalComplexesEl) {
                totalComplexesEl.textContent = totalComplexes;
            }
        }

        // Отображение связанных данных
        function displayLinkedData(linkedData) {
            const container = document.getElementById('linked-data-container');
            
            if (!container) {
                console.error('Контейнер linked-data-container не найден');
                return;
            }
            
            if (!linkedData || linkedData.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Нет связанных объектов и ЖК. Сначала выполните геокодирование.</div>';
                return;
            }
            
            container.innerHTML = linkedData.map((item, index) => `
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            ${item.address.address || 'Адрес не определен'}
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="showAddressOnMap('${item.address.latitude || ''}', '${item.address.longitude || ''}', ${JSON.stringify(item.address.address || '')})">
                                <i class="fas fa-map"></i> Показать на карте
                            </button>
                        </h5>
                        <small>${item.address.full_address || ''}</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Объекты недвижимости -->
                            <div class="col-md-6">
                                <h6 class="text-primary">
                                    <i class="fas fa-building me-1"></i>
                                    Объекты недвижимости (${item.properties.length})
                                </h6>
                                <div class="list-group">
                                    ${item.properties.map(property => `
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">${property.title}</h6>
                                                    <p class="mb-1 text-muted">${property.address}</p>
                                                    <div class="d-flex gap-2">
                                                        <span class="badge bg-success">${formatPrice(property.price)}</span>
                                                        <span class="badge bg-info">${formatArea(property.total_area)}</span>
                                                        <span class="badge bg-secondary">${property.rooms_count || 0} комн.</span>
                                                    </div>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="showPropertyDetails(${property.id})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Жилые комплексы -->
                            <div class="col-md-6">
                                <h6 class="text-success">
                                    <i class="fas fa-city me-1"></i>
                                    Жилые комплексы (${item.complexes.length})
                                </h6>
                                <div class="list-group">
                                    ${item.complexes.map(complex => `
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">${complex.name}</h6>
                                                    <p class="mb-1 text-muted">${complex.address}</p>
                                                    <div class="d-flex gap-2">
                                                        <span class="badge bg-warning">${complex.developer_name}</span>
                                                        <span class="badge bg-info">${complex.status}</span>
                                                        ${complex.ready_date ? `<span class="badge bg-success">${complex.ready_date}</span>` : ''}
                                                    </div>
                                                </div>
                                                ${complex.photo_url ? `
                                                    <img src="${complex.photo_url}" class="rounded" style="width: 50px; height: 40px; object-fit: cover;" 
                                                         onerror="this.style.display='none'">
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Показать адрес на карте во всплывающем окне (через propertyModal)
        function showAddressOnMap(lat, lng, address) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            modalTitle.textContent = address || 'Адрес на карте';
            // Вставляем div для карты
            modalBody.innerHTML = '<div id="address-map-container" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6;"></div>';
            const modal = new bootstrap.Modal(document.getElementById('propertyModal'));
            modal.show();
            setTimeout(() => {
                const mapDiv = document.getElementById('address-map-container');
                mapDiv.innerHTML = '';
                const latNum = parseFloat(lat);
                const lngNum = parseFloat(lng);
                addressMap = L.map('address-map-container').setView([latNum, lngNum], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(addressMap);
                L.marker([latNum, lngNum]).addTo(addressMap).bindPopup(address).openPopup();
                addressMap.invalidateSize();
            }, 300);
        }

        // Универсальная функция для показа toast-уведомлений
        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const typeClass = {
                'success': 'bg-success text-white',
                'danger': 'bg-danger text-white',
                'warning': 'bg-warning text-dark',
                'info': 'bg-info text-dark'
            }[type] || 'bg-info text-dark';
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center ${typeClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const container = document.getElementById('toast-container');
            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            setTimeout(() => {
                toast.hide();
                setTimeout(() => toastEl.remove(), 500);
            }, 3000);
        }

        // Импорт Яндекс-ЖК
        async function importYandexNewbuildings() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Импорт...';
            button.disabled = true;
            try {
                const response = await fetch('/api/import-yandex-newbuildings');
                const result = await response.json();
                if (result.success) {
                    showToast('Импорт Яндекс-ЖК завершен!', 'success');
                } else {
                    showToast('Ошибка: ' + result.error, 'danger');
                }
            } catch (e) {
                showToast('Ошибка при импорте Яндекс-ЖК', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function sendPhoneToCC(phone, propertyId, btn) {
            const button = btn;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Отправка...';
            button.disabled = true;
            try {
                const resp = await fetch('/api/send-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, property_id: propertyId })
                });
                const result = await resp.json();
                if (result.success) {
                    showToast('Телефон успешно отправлен в КЦ!', 'success');
                    // Обновляем только одну строку
                    const propResp = await fetch(`/api/properties?id=${propertyId}`);
                    const propData = await propResp.json();
                    if (propData.properties && propData.properties.length > 0) {
                        const property = propData.properties[0];
                        const html = `
                            <div class=\"list-item d-flex align-items-center\">
                                <div class=\"list-photo-column\">${getFirstImageForList(property.images, property.antiznak_photos)}</div>
                                <div class=\"list-info-column\">
                                    <div class=\"list-title\">${property.title}</div>
                                    <div class=\"list-address\">${property.dadata_address && property.dadata_address.address ? property.dadata_address.address : ''}</div>
                                    ${property.yandex_complex_name ? `<div class="text-primary small mb-1"><i class='fab fa-yandex me-1'></i>${property.yandex_complex_name}</div>` : ''}
                                    <div class=\"list-price\">${formatPrice(property.price)}</div>
                                    <div class=\"list-details\">
                                        <span class=\"list-badge\"><i class=\"fas fa-ruler-combined me-1\"></i>${formatArea(property.total_area)}</span>
                                        <span class=\"list-badge\"><i class=\"fas fa-door-open me-1\"></i>${property.rooms_count || 0} комн.</span>
                                        ${property.floor ? `<span class=\"list-badge\"><i class=\"fas fa-building me-1\"></i>${property.floor}/${property.total_floors || '?'} эт.</span>` : ''}
                                        ${property.construction_year ? `<span class=\"list-badge\"><i class=\"fas fa-calendar me-1\"></i>${property.construction_year}</span>` : ''}
                                        ${property.price_per_sqm ? `<span class=\"list-badge\"><i class=\"fas fa-calculator me-1\"></i>${formatPrice(property.price_per_sqm)}/м²</span>` : ''}
                                        ${property.rating && property.dadata_address && property.dadata_address.address ? `<span class="list-badge bg-warning"><i class="fas fa-star me-1"></i>Рейтинг Дома: ${property.rating}</span>` : ''}
                                        ${property.yandex_rating && property.yandex_complex_name ? `<span class="list-badge bg-info"><i class="fab fa-yandex me-1"></i>Рейтинг ЖК: ${property.yandex_rating}</span>` : ''}
                                    </div>
                                    ${property.description ? `<div class=\"list-description\">${property.description.substring(0, 150)}${property.description.length > 150 ? '...' : ''}</div>` : ''}
                                </div>
                                <div class=\"list-phone-column\"><span class=\"badge bg-success\">Отправлено в КЦ</span></div>
                                <div class=\"list-action-column\">
                                    <div class=\"d-grid gap-2\">
                                        <button class=\"btn btn-primary btn-sm\" onclick=\"showPropertyDetails(${property.id})\"><i class=\"fas fa-eye me-1\"></i>Подробнее</button>
                                        ${property.source_url && property.source_url.startsWith('http') && 
                                            (
                                                (!property.antiznak_photos || property.antiznak_photos.length === 0) || 
                                                (property.antiznak_status_status && property.antiznak_status_status !== 'done')
                                            ) ? `
                                            <button class=\"btn btn-warning btn-sm\" onclick=\"removeWatermarks(${property.id}, this)\"><i class=\"fas fa-eraser me-1\"></i>Удалить водяные знаки</button>` : ''}
                                        ${property.content ? `<button class="btn btn-outline-success btn-sm" onclick="generateDescription(${property.id}, this)"><i class="fas fa-magic me-1"></i>Генерировать описание</button>` : ''}
                                        ${property.latitude && property.longitude ? `<button class=\"btn btn-outline-info btn-sm\" onclick=\"geocodeProperty(${property.id}, this)\"><i class=\"fas fa-map-marker-alt me-1\"></i>Определить адрес</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        const row = document.getElementById(`property-row-${property.id}`);
                        if (row) row.innerHTML = html;
                    }
                } else {
                    showToast('Ошибка отправки: ' + (result.error || ''), 'danger');
                }
            } catch (e) {
                showToast('Ошибка при отправке в КЦ', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Проверка валидности source_url
        function isValidSourceUrl(url) {
            return url && typeof url === 'string' && url !== 'nan' && url !== 'None' && url.trim() !== '' && url.startsWith('http');
        }
        // Кнопка удаления водяных знаков
        function getRemoveWatermarksButton(property) {
            if (
                isValidSourceUrl(property.source_url) &&
                (
                    (!property.antiznak_photos || property.antiznak_photos.length === 0) ||
                    (property.antiznak_status_status && property.antiznak_status_status !== 'done')
                )
            ) {
                return `<button class="btn btn-warning btn-sm" onclick="removeWatermarks(${property.id}, this)"><i class="fas fa-eraser me-1"></i>Удалить водяные знаки</button>`;
            }
            return '';
        }

        // Загрузка списка Яндекс-ЖК для фильтра
        async function loadYandexComplexesList() {
            try {
                const resp = await fetch('/api/yandex-linked-complexes');
                const complexes = await resp.json();
                const select = document.getElementById('yandex-complex-filter');
                select.innerHTML = '<option value="">Все</option>' + complexes.map(name => `<option value="${name.replace(/"/g, '&quot;')}">${name}</option>`).join('');
            } catch (e) {
                // fallback: ничего не делаем
            }
        }

        // Массовое обновление рейтинга
        async function updateRatings(event) {
            console.log('updateRatings called');
            alert('Функция updateRatings вызвана!');
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обновление...';
            button.disabled = true;
            try {
                // Обновляем оба рейтинга
                const resp1 = await fetch('/api/update-ratings', {method: 'POST'});
                const resp2 = await fetch('/api/update-yandex-ratings', {method: 'POST'});
                const result1 = await resp1.json();
                const result2 = await resp2.json();
                if (result1.success && result2.success) {
                    showToast('Рейтинги обновлены!', 'success');
                    loadProperties(currentPage);
                } else {
                    showToast('Ошибка обновления рейтингов', 'danger');
                }
            } catch (e) {
                showToast('Ошибка обновления рейтингов', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Экспорт объектов в CSV
        async function exportToCSV(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Экспорт...';
            button.disabled = true;
            
            try {
                // Используем текущие фильтры из поиска
                const params = new URLSearchParams();
                
                // Добавляем все текущие фильтры
                Object.keys(currentFilters).forEach(key => {
                    params.append(key, currentFilters[key]);
                });
                
                // Проверяем, есть ли фильтры
                const hasFilters = Object.keys(currentFilters).length > 0;
                
                if (!hasFilters) {
                    if (!confirm('Нет активных фильтров. Экспортировать все объекты (7201 записей)?')) {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        return;
                    }
                }
                
                // Используем fetch для скачивания с параметрами
                const url = `/export-properties-csv?${params.toString()}`;
                
                // Формируем имя файла с учетом фильтров
                let filename = 'properties_export';
                
                // Добавляем информацию о фильтрах в имя файла
                if (currentFilters.q) {
                    filename += `_search_${currentFilters.q.replace(/[^a-zA-Z0-9]/g, '_')}`;
                }
                if (currentFilters.contacts_only) {
                    filename += '_with_contacts';
                }
                if (currentFilters.in_sale_only) {
                    filename += '_in_sale';
                }
                if (currentFilters.yandex_complex) {
                    filename += `_complex_${currentFilters.yandex_complex.replace(/[^a-zA-Z0-9]/g, '_')}`;
                }
                if (currentFilters.price_min || currentFilters.price_max) {
                    filename += `_price_${currentFilters.price_min || 0}-${currentFilters.price_max || 'max'}`;
                }
                if (currentFilters.area_min || currentFilters.area_max) {
                    filename += `_area_${currentFilters.area_min || 0}-${currentFilters.area_max || 'max'}`;
                }
                
                filename += `_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                
                // Скачиваем файл через fetch
                const response = await fetch(url);
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const message = hasFilters ? `Экспорт результатов поиска начат! (${Object.keys(currentFilters).length} фильтров)` : 'Экспорт всех объектов начат!';
                showToast(message, 'success');
            } catch (e) {
                showToast('Ошибка экспорта CSV: ' + e.message, 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Обновление связей объектов с Яндекс-ЖК
        async function updateYandexLinks(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обновление связей...';
            button.disabled = true;
            try {
                const response = await fetch('/api/update-yandex-links', {method: 'POST'});
                const result = await response.json();
                if (result.success) {
                    showToast(`Связи обновлены! Создано ${result.links_created} связей.`, 'success');
                    loadYandexComplexesList(); // Обновляем список ЖК в фильтре
                } else {
                    showToast('Ошибка обновления связей', 'danger');
                }
            } catch (e) {
                showToast('Ошибка обновления связей', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Генерация описания объекта
        async function generateDescription(propertyId, btn) {
            const button = btn;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Генерация...';
            button.disabled = true;
            
            try {
                const response = await fetch(`/api/generate-description/${propertyId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Описание успешно сгенерировано!', 'success');
                    // Обновляем только одну строку
                    const propResp = await fetch(`/api/properties?id=${propertyId}`);
                    const propData = await propResp.json();
                    if (propData.properties && propData.properties.length > 0) {
                        const property = propData.properties[0];
                        const html = `
                            <div class=\"list-item d-flex align-items-center\">
                                <div class=\"list-photo-column\">${getFirstImageForList(property.images, property.antiznak_photos)}</div>
                                <div class=\"list-info-column\">
                                    <div class=\"list-title\">${property.title}</div>
                                    <div class=\"list-address\">${property.dadata_address && property.dadata_address.address ? property.dadata_address.address : ''}</div>
                                    ${property.yandex_complex_name ? `<div class="text-primary small mb-1"><i class='fab fa-yandex me-1'></i>${property.yandex_complex_name}</div>` : ''}
                                    <div class=\"list-price\">${formatPrice(property.price)}</div>
                                    <div class=\"list-details\">
                                        <span class=\"list-badge\"><i class=\"fas fa-ruler-combined me-1\"></i>${formatArea(property.total_area)}</span>
                                        <span class=\"list-badge\"><i class=\"fas fa-door-open me-1\"></i>${property.rooms_count || 0} комн.</span>
                                        ${property.floor ? `<span class=\"list-badge\"><i class=\"fas fa-building me-1\"></i>${property.floor}/${property.total_floors || '?'} эт.</span>` : ''}
                                        ${property.construction_year ? `<span class=\"list-badge\"><i class=\"fas fa-calendar me-1\"></i>${property.construction_year}</span>` : ''}
                                        ${property.price_per_sqm ? `<span class=\"list-badge\"><i class=\"fas fa-calculator me-1\"></i>${formatPrice(property.price_per_sqm)}/м²</span>` : ''}
                                        ${property.rating && property.dadata_address && property.dadata_address.address ? `<span class="list-badge bg-warning"><i class="fas fa-star me-1"></i>Рейтинг Дома: ${property.rating}</span>` : ''}
                                        ${property.yandex_rating && property.yandex_complex_name ? `<span class="list-badge bg-info"><i class="fab fa-yandex me-1"></i>Рейтинг ЖК: ${property.yandex_rating}</span>` : ''}
                                    </div>
                                    ${property.description ? `<div class=\"list-description\">${property.description.substring(0, 150)}${property.description.length > 150 ? '...' : ''}</div>` : ''}
                                    ${property.generated_description ? `<div class="list-description text-success"><i class="fas fa-magic me-1"></i>${property.generated_description.substring(0, 150)}${property.generated_description.length > 150 ? '...' : ''}</div>` : ''}
                                </div>
                                <div class=\"list-phone-column\">${formatContacts(property.contacts)}</div>
                                <div class=\"list-action-column\">
                                    <div class=\"d-grid gap-2\">
                                        <button class=\"btn btn-primary btn-sm\" onclick=\"showPropertyDetails(${property.id})\"><i class=\"fas fa-eye me-1\"></i>Подробнее</button>
                                        ${property.source_url && property.source_url.startsWith('http') && 
                                            (
                                                (!property.antiznak_photos || property.antiznak_photos.length === 0) || 
                                                (property.antiznak_status_status && property.antiznak_status_status !== 'done')
                                            ) ? `
                                            <button class=\"btn btn-warning btn-sm\" onclick=\"removeWatermarks(${property.id}, this)\"><i class=\"fas fa-eraser me-1\"></i>Удалить водяные знаки</button>` : ''}
                                        ${property.content ? `<button class="btn btn-outline-success btn-sm" onclick="generateDescription(${property.id}, this)"><i class="fas fa-magic me-1"></i>Генерировать описание</button>` : ''}
                                        ${property.latitude && property.longitude ? `<button class=\"btn btn-outline-info btn-sm\" onclick=\"geocodeProperty(${property.id}, this)\"><i class=\"fas fa-map-marker-alt me-1\"></i>Определить адрес</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        const row = document.getElementById(`property-row-${property.id}`);
                        if (row) row.innerHTML = html;
                    }
                } else {
                    showToast('Ошибка генерации: ' + (result.error || ''), 'danger');
                }
            } catch (e) {
                showToast('Ошибка при генерации описания', 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // --- Найти обработку autocomplete ---
        document.getElementById('global-search').addEventListener('input', function(e) {
            const q = e.target.value.trim();
            clearTimeout(autocompleteTimeout);
            if (!q) {
                document.getElementById('autocomplete-list').innerHTML = '';
                return;
            }
            autocompleteTimeout = setTimeout(async () => {
                const resp = await fetch(`/api/objects-autocomplete?q=${encodeURIComponent(q)}`);
                const data = await resp.json();
                let html = '';
                for (const group of ['id', 'address', 'complex', 'phone']) {
                    if (data[group] && data[group].length) {
                        html += `<div class='list-group-item active'>${group === 'id' ? 'ID' : group === 'address' ? 'Адрес' : group === 'complex' ? 'ЖК' : 'Телефон'}</div>`;
                        if (group === 'complex') {
                            const unique = [];
                            const seen = new Set();
                            data.complex.forEach(item => {
                                if (!seen.has(item.name)) {
                                    unique.push(item);
                                    seen.add(item.name);
                                }
                            });
                            unique.forEach(item => {
                                html += `<button type='button' class='list-group-item list-group-item-action' onclick='selectAutocompleteValue("${item.name}", "${item.id}")'>${item.name} (${item.count})</button>`;
                            });
                        } else {
                            const unique = Array.from(new Set(data[group]));
                            unique.forEach(val => {
                                html += `<button type='button' class='list-group-item list-group-item-action' onclick='selectAutocompleteValue("${val}")'>${val}</button>`;
                            });
                        }
                    }
                }
                document.getElementById('autocomplete-list').innerHTML = html;
            }, 200);
        });

        window.selectAutocompleteValue = function(val, id) {
            document.getElementById('global-search').value = val;
            document.getElementById('autocomplete-list').innerHTML = '';
            currentFilters = { q: val };
            if (id) {
                currentFilters.yandex_building_id = id;
            }
            loadProperties(1);
        };

        document.getElementById('global-search').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                currentFilters = { q: e.target.value.trim() };
                document.getElementById('autocomplete-list').innerHTML = '';
                loadProperties(1);
            }
        });

        function importSellerContacts() {
            if (!confirm('Импортировать продавцов из Google Sheets? Все старые данные будут удалены.')) return;
            fetch('/api/import-seller-contacts')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('Импорт завершен!');
                    } else {
                        alert('Ошибка импорта!');
                    }
                })
                .catch(() => alert('Ошибка запроса!'));
        }

        function importTrendagent() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Импорт...';
            btn.disabled = true;
            fetch('/api/import-trendagent', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('Импорт trendagent завершен!', 'success');
                    } else {
                        showToast('Ошибка импорта trendagent: ' + (data.error || ''), 'danger');
                    }
                })
                .catch(e => {
                    showToast('Ошибка импорта trendagent', 'danger');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        async function exportCSV() {
            try {
                // Собираем текущие фильтры
                const filters = new URLSearchParams();
                
                // Добавляем все активные фильтры
                if (currentFilters.q) filters.append('q', currentFilters.q);
                if (currentFilters.contacts_only) filters.append('contacts_only', '1');
                if (currentFilters.in_sale_only) filters.append('in_sale_only', '1');
                if (currentFilters.yandex_complex) filters.append('yandex_complex', currentFilters.yandex_complex);
                if (currentFilters.price_min) filters.append('price_min', currentFilters.price_min);
                if (currentFilters.price_max) filters.append('price_max', currentFilters.price_max);
                if (currentFilters.area_min) filters.append('area_min', currentFilters.area_min);
                if (currentFilters.area_max) filters.append('area_max', currentFilters.area_max);
                if (currentFilters.rooms) filters.append('rooms', currentFilters.rooms);
                if (currentFilters.rating_min) filters.append('rating_min', currentFilters.rating_min);
                if (currentFilters.rating_max) filters.append('rating_max', currentFilters.rating_max);
                if (currentFilters.yandex_rating_min) filters.append('yandex_rating_min', currentFilters.yandex_rating_min);
                if (currentFilters.yandex_rating_max) filters.append('yandex_rating_max', currentFilters.yandex_rating_max);
                if (currentFilters.in_complex_only) filters.append('in_complex_only', '1');
                if (currentFilters.yandex_building_id) filters.append('yandex_building_id', currentFilters.yandex_building_id);
                
                // Создаем ссылку для скачивания
                const downloadUrl = `/export-properties-csv?${filters.toString()}`;
                
                // Используем fetch для проверки ответа
                const response = await fetch(downloadUrl);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `properties_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showToast('Экспорт CSV завершен', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (e) {
                showToast('Ошибка экспорта CSV: ' + e.message, 'danger');
                console.error('Ошибка экспорта:', e);
            }
        }

        function showRecentChanges() {
            fetch('/api/recent-price-changes?limit=20&days=7')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let html = '<div class="modal fade" id="changesModal" tabindex="-1">';
                        html += '<div class="modal-dialog modal-lg">';
                        html += '<div class="modal-content">';
                        html += '<div class="modal-header">';
                        html += '<h5 class="modal-title">💰 Последние изменения цен</h5>';
                        html += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
                        html += '</div>';
                        html += '<div class="modal-body">';
                        html += '<div class="table-responsive">';
                        html += '<table class="table table-sm">';
                        html += '<thead><tr><th>Объект</th><th>Старая цена</th><th>Новая цена</th><th>Изменение</th><th>%</th><th>Когда</th></tr></thead>';
                        html += '<tbody>';
                        
                        data.price_changes.forEach(record => {
                            const changeClass = record.price_change > 0 ? 'text-success' : record.price_change < 0 ? 'text-danger' : 'text-muted';
                            const changeSymbol = record.price_change > 0 ? '📈' : record.price_change < 0 ? '📉' : '➡️';
                            
                            html += `<tr>
                                <td><a href="#" onclick="showProperty(${record.property_id})">${record.property_id}</a></td>
                                <td class="text-muted">${record.old_price ? record.old_price.toLocaleString() : '-'} ₽</td>
                                <td class="text-success">${record.new_price.toLocaleString()} ₽</td>
                                <td class="${changeClass}">${changeSymbol} ${record.price_change > 0 ? '+' : ''}${record.price_change.toLocaleString()} ₽</td>
                                <td class="${changeClass}">${record.change_percent > 0 ? '+' : ''}${record.change_percent.toFixed(1)}%</td>
                                <td>${new Date(record.changed_at).toLocaleString()}</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div></div></div></div>';
                        
                        // Удаляем старый модал если есть
                        const oldModal = document.getElementById('changesModal');
                        if (oldModal) oldModal.remove();
                        
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('changesModal')).show();
                    } else {
                        alert('Ошибка загрузки истории: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка загрузки истории изменений');
                });
        }

        function showPriceStatistics() {
            fetch('/api/price-statistics?days=30')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.statistics;
                        let html = '<div class="modal fade" id="statsModal" tabindex="-1">';
                        html += '<div class="modal-dialog">';
                        html += '<div class="modal-content">';
                        html += '<div class="modal-header">';
                        html += '<h5 class="modal-title">📈 Статистика изменений цен</h5>';
                        html += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>';
                        html += '</div>';
                        html += '<div class="modal-body">';
                        html += '<div class="row text-center">';
                        html += '<div class="col-md-4"><div class="card bg-primary text-white"><div class="card-body"><h4>'+stats.total_changes+'</h4><p>Всего изменений</p></div></div></div>';
                        html += '<div class="col-md-4"><div class="card bg-success text-white"><div class="card-body"><h4>'+stats.price_increases+'</h4><p>Повышений цены</p></div></div></div>';
                        html += '<div class="col-md-4"><div class="card bg-danger text-white"><div class="card-body"><h4>'+stats.price_decreases+'</h4><p>Снижений цены</p></div></div></div>';
                        html += '</div>';
                        html += '<div class="row mt-3">';
                        html += '<div class="col-md-6"><div class="card"><div class="card-body text-center"><h5 class="text-success">+'+stats.avg_increase_percent+'%</h5><p>Среднее повышение</p></div></div></div>';
                        html += '<div class="col-md-6"><div class="card"><div class="card-body text-center"><h5 class="text-danger">'+stats.avg_decrease_percent+'%</h5><p>Среднее снижение</p></div></div></div>';
                        html += '</div>';
                        html += '<div class="mt-3"><small class="text-muted">За последние '+stats.period_days+' дней</small></div>';
                        html += '</div></div></div></div>';
                        
                        // Удаляем старый модал если есть
                        const oldModal = document.getElementById('statsModal');
                        if (oldModal) oldModal.remove();
                        
                        document.body.insertAdjacentHTML('beforeend', html);
                        new bootstrap.Modal(document.getElementById('statsModal')).show();
                    } else {
                        alert('Ошибка загрузки статистики: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка загрузки статистики');
                });
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
{% endblock %}